# ä»£ç å®¡æŸ¥æŠ¥å‘Š - é€»è¾‘é”™è¯¯ä¿®å¤

## ä»£ç å®¡æŸ¥æ€»ç»“

æœ¬æ¬¡å®¡æŸ¥å‘ç°äº†å¤šä¸ªé€»è¾‘é”™è¯¯å’Œæ½œåœ¨é—®é¢˜ï¼Œå·²å…¨éƒ¨ä¿®å¤ã€‚

## å·²ä¿®å¤çš„é—®é¢˜

### 1. å¯¼å…¥é”™è¯¯

**æ–‡ä»¶**: `src/tools/tool_registry.py`
- **é—®é¢˜**: `list_tools()` æ–¹æ³•ä½¿ç”¨äº† `List` ç±»å‹ä½†æœªå¯¼å…¥
- **ä¿®å¤**: æ·»åŠ  `List` åˆ°å¯¼å…¥è¯­å¥

**æ–‡ä»¶**: `src/tools/search_tool.py`
- **é—®é¢˜**: `_extract_results()` æ–¹æ³•è¿”å›ç±»å‹ä½¿ç”¨äº† `List` ä½†æœªå¯¼å…¥
- **ä¿®å¤**: æ·»åŠ  `List` åˆ°å¯¼å…¥è¯­å¥

### 2. æ–¹æ³•ç¼ºå¤±

**æ–‡ä»¶**: `src/agent/multi_agent_system.py`
- **é—®é¢˜**: `CoordinationAgent._format_reasoning()` æ–¹æ³•è¢«è°ƒç”¨ä½†å®šä¹‰ç¼ºå¤±
- **ä¿®å¤**: æ·»åŠ  `_format_reasoning()` æ–¹æ³•å®ç°

### 3. ç±»å‹å…¼å®¹æ€§é—®é¢˜

**æ–‡ä»¶**: `src/agent/multi_agent_system.py`
- **é—®é¢˜**: `AgentState` ä½¿ç”¨äº† `add_messages`ï¼Œä½† LangGraph ä¸å¯ç”¨æ—¶ä¼šæŠ¥é”™
- **ä¿®å¤**: æ·»åŠ æ¡ä»¶åˆ¤æ–­å’Œå¼‚å¸¸å¤„ç†ï¼ŒLangGraph ä¸å¯ç”¨æ—¶ä½¿ç”¨ç®€åŒ–ç‰ˆ `AgentState`

**æ–‡ä»¶**: `src/agent/langgraph_workflow.py`
- **é—®é¢˜**: `WorkflowState` åŒæ ·ä½¿ç”¨äº† `add_messages`ï¼Œå­˜åœ¨ç›¸åŒé—®é¢˜
- **ä¿®å¤**: æ·»åŠ ç›¸åŒçš„æ¡ä»¶åˆ¤æ–­å’Œå¼‚å¸¸å¤„ç†æœºåˆ¶

### 4. å¼‚æ­¥/åŒæ­¥æ··ç”¨

**æ–‡ä»¶**: `src/tools/search_tool.py`
- **é—®é¢˜**: `execute()` æ˜¯å¼‚æ­¥æ–¹æ³•ï¼Œä½†å†…éƒ¨ä½¿ç”¨åŒæ­¥ `requests.get()`ï¼Œä¼šé˜»å¡äº‹ä»¶å¾ªç¯
- **ä¿®å¤**: ä½¿ç”¨ `asyncio.run_in_executor()` åœ¨åå°çº¿ç¨‹æ‰§è¡ŒåŒæ­¥è¯·æ±‚

**æ–‡ä»¶**: `src/agent/multi_agent_system.py`
- **é—®é¢˜**: åœ¨å¼‚æ­¥æ–¹æ³•ä¸­è°ƒç”¨åŒæ­¥çš„ `LLM.generate()`
- **ä¿®å¤**: æ·»åŠ æ³¨é‡Šè¯´æ˜ï¼Œå¦‚éœ€ä¼˜åŒ–å¯ä½¿ç”¨ `asyncio.to_thread()`

### 5. é‡å¤ä»£ç 

**æ–‡ä»¶**: `src/api/http_server.py`
- **é—®é¢˜**: å¯¼å…¥é€»è¾‘é‡å¤
- **ä¿®å¤**: ç§»é™¤é‡å¤çš„å¯¼å…¥å¤„ç†ä»£ç 

## æ½œåœ¨é—®é¢˜ï¼ˆéœ€è¦å…³æ³¨ï¼‰

### 1. LLMè°ƒç”¨æ€§èƒ½

**ä½ç½®**: `src/agent/multi_agent_system.py`
- **é—®é¢˜**: åœ¨å¼‚æ­¥ç¯å¢ƒä¸­è°ƒç”¨åŒæ­¥çš„ `LLM.generate()` å¯èƒ½é˜»å¡äº‹ä»¶å¾ªç¯
- **å»ºè®®**: å¦‚æœæ€§èƒ½æœ‰é—®é¢˜ï¼Œè€ƒè™‘ï¼š
  - ä½¿ç”¨ `asyncio.to_thread()` åŒ…è£…åŒæ­¥è°ƒç”¨
  - æˆ–ä½¿ç”¨å¼‚æ­¥HTTPå®¢æˆ·ç«¯ï¼ˆå¦‚ `aiohttp`ï¼‰é‡å†™ LLM å®¢æˆ·ç«¯

### 2. é”™è¯¯å¤„ç†

**ä½ç½®**: å¤šä¸ªæ–‡ä»¶
- **é—®é¢˜**: æŸäº›å¼‚å¸¸å¯èƒ½è¢«é™é»˜åæ‰
- **å»ºè®®**: ç¡®ä¿æ‰€æœ‰å…³é”®è·¯å¾„éƒ½æœ‰é€‚å½“çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

### 3. ç©ºå€¼æ£€æŸ¥

**ä½ç½®**: `src/agent/multi_agent_system.py`
- **é—®é¢˜**: æŸäº›åœ°æ–¹ç¼ºå°‘ç©ºå€¼æ£€æŸ¥
- **å»ºè®®**: æ·»åŠ æ›´å¤šçš„é˜²å¾¡æ€§ç¼–ç¨‹æ£€æŸ¥

### 4. å·¥å…·è°ƒç”¨å¤±è´¥å¤„ç†

**ä½ç½®**: `src/agent/multi_agent_system.py` - `ExecutionAgent`
- **é—®é¢˜**: å·¥å…·è°ƒç”¨å¤±è´¥æ—¶çš„é™çº§ç­–ç•¥å¯èƒ½ä¸å¤Ÿå®Œå–„
- **å»ºè®®**: å®ç°æ›´å®Œå–„çš„é”™è¯¯æ¢å¤æœºåˆ¶

## ä»£ç è´¨é‡å»ºè®®

### 1. ç±»å‹æç¤º

- æ‰€æœ‰å…¬å…±æ–¹æ³•éƒ½åº”è¯¥æœ‰å®Œæ•´çš„ç±»å‹æç¤º
- ä½¿ç”¨ `Optional` æ˜ç¡®æ ‡æ³¨å¯èƒ½ä¸º None çš„å€¼

### 2. æ–‡æ¡£å­—ç¬¦ä¸²

- ç¡®ä¿æ‰€æœ‰å…¬å…±ç±»å’Œæ–¹æ³•éƒ½æœ‰æ–‡æ¡£å­—ç¬¦ä¸²
- æ–‡æ¡£å­—ç¬¦ä¸²åº”åŒ…å«å‚æ•°è¯´æ˜å’Œè¿”å›å€¼è¯´æ˜

### 3. æµ‹è¯•è¦†ç›–

- å»ºè®®æ·»åŠ å•å…ƒæµ‹è¯•è¦†ç›–å…³é”®é€»è¾‘
- ç‰¹åˆ«æ˜¯å·¥å…·è°ƒç”¨ã€LLMè°ƒç”¨ã€é”™è¯¯å¤„ç†ç­‰è·¯å¾„

### 4. æ—¥å¿—è®°å½•

- ç¡®ä¿å…³é”®æ“ä½œéƒ½æœ‰æ—¥å¿—è®°å½•
- ä½¿ç”¨é€‚å½“çš„æ—¥å¿—çº§åˆ«ï¼ˆDEBUG, INFO, WARNING, ERRORï¼‰

---

## 2026-01 å…¨ä»£ç æ£€æŸ¥ï¼ˆè§„åˆ’ä¸å·¥å…·è°ƒç”¨ç­–ç•¥ä¼˜å…ˆï¼‰

### æ£€æŸ¥èŒƒå›´

- è§„åˆ’ç­–ç•¥ï¼š`PlanningAgent`ã€`planning.yaml`ã€`langgraph_workflow._planning_node`
- å·¥å…·è°ƒç”¨ç­–ç•¥ï¼š`task_router`ã€`tool_routing.yaml`ã€`ToolHub`ã€`ExecutionAgent._execute_with_tool`
- æç¤ºè¯ï¼š`src/prompts/*.yaml` ä¸ä»£ç ä¸­ `get_prompt`/`get_prompt_raw` çš„ key ä¸€è‡´æ€§
- ä¸ `add/` ç›®å½•çš„å†²çªã€é…ç½®ä¸€è‡´æ€§

### å·²ä¿®å¤ / æ”¹è¿›

1. **è§„åˆ’èŠ‚ç‚¹ä¼ å…¥ context**ï¼ˆ`src/agent/langgraph_workflow.py`ï¼‰  
   - `_planning_node` åŸåªä¼  `state["question"]`ï¼Œç°å¢åŠ  `context=state.get("metadata")`ï¼Œä¾¿äºè§„åˆ’å±‚ä½¿ç”¨ä»»åŠ¡è·¯ç”±äº§ç”Ÿçš„ `task_ctx`ï¼ˆèƒ½åŠ›æ ‡ç­¾ç­‰ï¼‰ã€‚
2. **æ‰§è¡ŒèŠ‚ç‚¹é˜²å¾¡æ€§æ£€æŸ¥**  
   - `_execution_node` åœ¨ `append` å‰ç¡®ä¿ `state["step_results"]` å­˜åœ¨ï¼Œé¿å…å¼‚å¸¸ state å¯¼è‡´ KeyErrorã€‚
3. **æç¤ºè¯ key æ ¸å¯¹**  
   - æ‰€æœ‰å¼•ç”¨å·²ä¸ YAML æ ¸å¯¹ï¼š`planning_*`ã€`execution_*`ã€`tool_routing_*`ã€`orchestrator_*`ã€`synthesis_*` å‡å­˜åœ¨ä¸”ä¸€è‡´ã€‚

### ç»“è®ºï¼ˆæ— å†²çªï¼‰

- **add/tool ä¸ src/**ï¼šä»£ç ä¸­æ—  `from add`/`import add`ï¼Œ`add/` ä¸ºç‹¬ç«‹æˆ–å†å²ä»£ç ï¼Œä¸ `src` æ— å¼•ç”¨å†²çªã€‚
- **é…ç½®**ï¼š`config.yaml` ä¸­ `tools.use_task_router`ã€`observability`ã€`performance` ç­‰ä¸ `orchestrator`/`task_router`/`toolhub` ä½¿ç”¨æ–¹å¼ä¸€è‡´ã€‚
- **æµ‹è¯•**ï¼š`tests/` ä¾èµ– pytestï¼Œéœ€å…ˆæ‰§è¡Œ `pip install pytest` å†è¿è¡Œæµ‹è¯•ï¼›æç¤ºè¯ä¸ agent æ¨¡å—å¯¼å…¥éªŒè¯å·²é€šè¿‡ã€‚

### ç­–ç•¥ä¼˜å…ˆçº§å°ç»“

| ç­–ç•¥           | ä½ç½®                     | è¯´æ˜ |
|----------------|--------------------------|------|
| ä»»åŠ¡å…ˆéªŒè·¯ç”±   | `task_router.route_task` | é…ç½® `tools.use_task_router: true` æ—¶å…ˆåˆ¤æ–­æ˜¯å¦éœ€è°ƒå·¥å…·ï¼Œå¹¶äº§å‡º capability_tags/task_ctx |
| è§„åˆ’åˆ†è§£       | `PlanningAgent.decompose_task` | ä½¿ç”¨ `planning.yaml`ï¼Œç°å¯æ¥æ”¶ contextï¼ˆå« task_ctxï¼‰ |
| å·¥å…·æ‰§è¡Œ       | `ToolHub.execute` / `ExecutionAgent._execute_with_tool` | ä¼˜å…ˆæŒ‰åç§°ï¼Œå†æŒ‰èƒ½åŠ›ç›¸ä¼¼ + task_ctx æ‰“åˆ† |
| åˆæˆ           | `_synthesis_node`ï¼ˆç®€å•å–æœ€åæˆåŠŸç»“æœï¼‰/ `CoordinationAgent`ï¼ˆLLM åˆæˆï¼‰ | å›¾å·¥ä½œæµç”¨ç®€å•ç­–ç•¥ï¼Œç›´æ¥è°ƒç”¨å¤š Agent æ—¶å¯ç”¨ evidence_synthesis |

---

## ä¿®å¤æ€»ç»“

âœ… **å·²ä¿®å¤**: 5ä¸ªå…³é”®é—®é¢˜ + æœ¬æ¬¡è§„åˆ’/å·¥å…·ç­–ç•¥ç›¸å…³ 2 å¤„æ”¹è¿›
âš ï¸ **éœ€è¦å…³æ³¨**: 4ä¸ªæ½œåœ¨é—®é¢˜
ğŸ“ **å»ºè®®æ”¹è¿›**: ä»£ç è´¨é‡æå‡å»ºè®®ï¼›è¿è¡Œå•å…ƒæµ‹è¯•å‰éœ€ `pip install pytest`

æ‰€æœ‰ä¿®å¤å·²åº”ç”¨åˆ°ä»£ç ä¸­ï¼Œä»£ç ç°åœ¨åº”è¯¥å¯ä»¥æ­£å¸¸è¿è¡Œã€‚
