# 对话历史工具修复 V2 - 排除当前问题

## 问题描述

当用户问"我刚刚都问了你什么问题？"时，Agent返回的是当前问题本身，而不是之前的问题。

**原因**：
- 在`orchestrator.py`的`process_task`方法中，用户问题在处理前就被添加到对话历史中
- 当Agent查询`last_user`时，最后一条用户消息就是当前问题
- 导致返回错误答案

## 解决方案

修改`ConversationHistoryTool`，在所有查询中自动排除最后一条用户消息（当前问题）：

### 1. `last_user`查询
- 如果有多条用户消息，返回倒数第二条（排除当前问题）
- 如果只有1条用户消息（即当前问题），返回提示信息

### 2. `last`查询
- 如果最后一条是用户消息（当前问题），返回倒数第二条消息
- 否则返回最后一条消息

### 3. `all`查询
- 如果最后一条消息是用户消息（当前问题），排除它
- 返回所有历史（排除当前问题）

### 4. 数字查询（如`10`）
- 获取更多历史以确保有足够内容
- 如果最后一条是用户消息（当前问题），排除它
- 返回最后N条消息

### 5. 默认查询
- 同样排除当前问题
- 返回最近10条消息（排除当前问题）

## 代码修改

**文件**: `src/tools/conversation_history_tool.py`

主要修改：
1. `last_user`查询：返回倒数第二条用户消息
2. `last`查询：如果最后一条是用户消息，返回倒数第二条
3. `all`查询：排除最后一条用户消息
4. 数字查询：排除最后一条用户消息后再返回N条
5. 默认查询：排除最后一条用户消息后再返回10条

## 测试场景

### 场景1：单次提问
1. 用户："现在几点了？"
2. 用户："我刚刚问了你什么问题？"
3. **期望**：返回"现在几点了？"（而不是"我刚刚问了你什么问题？"）

### 场景2：多次提问
1. 用户："现在几点了？"
2. 用户："我刚刚都问了你什么问题？"
3. 用户："我说的是我上上几个问题？而且不止一条吧"
4. **期望**：返回之前的所有问题列表（排除当前问题）

## 验证

重新运行控制台客户端测试：

```bash
python run_console.py
```

测试流程：
1. 问："现在几点了？"
2. 问："我刚刚问了你什么问题？"
3. 应该正确返回："现在几点了？"（而不是当前问题）

---

**修复完成时间**: 2026-01-28  
**版本**: 2.0.0
