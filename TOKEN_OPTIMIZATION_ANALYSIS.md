# Token消耗分析与优化方案

## 当前Token消耗点分析

### 1. PlanningAgent中的工具列表（中等风险）
**位置**: `src/agent/multi_agent_system.py:_build_decomposition_prompt`
- **问题**: `available_tools`列表会包含所有工具名称（tools + skills + mcps）
- **影响**: 如果工具很多（如20个skills + 10个mcps），列表会很长
- **当前实现**: `{', '.join(available_tools)}` 直接拼接所有工具名
- **Token消耗**: 每个工具名约5-20 tokens，30个工具约150-600 tokens

### 2. _synthesize_results方法（高风险）
**位置**: `src/toolhub.py:_synthesize_results`
- **问题**: 
  - 每个工具结果最多截取500字符：`result_str[:500]`
  - 如果有5个工具，就是2500字符（约625-1000 tokens）
  - 还会调用额外的LLM来综合，又是一次完整的prompt消耗
- **Token消耗**: 
  - 输入: 2500字符 + prompt模板 ≈ 800-1200 tokens
  - 输出: 综合结果 ≈ 200-500 tokens
  - **总计**: 每次综合约1000-1700 tokens

### 3. 工具结果在后续步骤中的传递（高风险）
**位置**: `src/agent/multi_agent_system.py:_format_tool_result` 和后续推理
- **问题**: 
  - 工具结果会被包含在后续的推理过程中
  - 如果工具返回大量数据（如搜索结果、PDF内容），会占用大量token
- **当前限制**: 
  - `search_web`只取前3个结果（已优化）
  - 但其他工具没有限制
- **Token消耗**: 取决于工具返回的数据量，可能数百到数千tokens

### 4. 工具元数据传递（低风险）
**位置**: 工具注册和描述
- **问题**: 能力标签、描述等信息可能被多次传递
- **影响**: 较小，通常只有几十tokens

## 优化方案

### 方案1: 限制工具列表长度（简单有效）
**目标**: 减少PlanningAgent中的工具列表长度

**实现**:
1. 只传递核心工具名称（最多10-15个）
2. 对于skills和mcps，只传递类别或代表性工具
3. 添加提示："其他工具可通过工具名称直接调用"

**预期节省**: 50-70%的工具列表token消耗

### 方案2: 优化synthesize策略（高优先级）
**目标**: 减少综合结果的token消耗

**实现**:
1. **智能截断**: 根据工具类型和结果长度动态截断
   - 计算类工具: 只保留最终结果（通常很短）
   - 搜索类工具: 每个结果最多200字符
   - 数据提取类工具: 每个结果最多300字符
2. **提前降级**: 如果结果总长度超过阈值（如1500字符），直接使用简单合并，不调用LLM
3. **结果摘要**: 对于超长结果，先提取关键信息再综合

**预期节省**: 30-50%的综合token消耗

### 方案3: 限制工具结果长度（高优先级）
**目标**: 防止工具结果占用过多token

**实现**:
1. 在`_format_tool_result`中统一限制结果长度
2. 根据工具类型设置不同的最大长度：
   - 计算类: 100字符
   - 时间类: 200字符
   - 搜索类: 500字符（已实现，取前3个）
   - 历史类: 1000字符
   - 其他: 500字符
3. 超长结果自动截断并添加"...（已截断）"标记

**预期节省**: 50-80%的工具结果token消耗

### 方案4: 延迟加载工具描述（中等优先级）
**目标**: 减少工具描述在prompt中的占用

**实现**:
1. PlanningAgent中不包含详细的工具描述
2. 只传递工具名称和简短类别
3. 详细描述在需要时通过工具元数据获取

**预期节省**: 20-30%的prompt token消耗

## 推荐实施顺序

1. **立即实施**: 方案3（限制工具结果长度）- 影响最大，实现简单
2. **高优先级**: 方案2（优化synthesize策略）- 减少额外的LLM调用
3. **中优先级**: 方案1（限制工具列表长度）- 减少规划阶段的token消耗
4. **可选**: 方案4（延迟加载工具描述）- 进一步优化

## 预期效果

实施所有优化后，预计可以：
- **减少30-50%的token消耗**（主要来自工具结果和综合）
- **提高响应速度**（减少LLM调用次数和prompt长度）
- **降低API成本**（减少token使用量）

## 风险评估

- **信息丢失风险**: 截断可能导致关键信息丢失
  - **缓解**: 智能截断（保留关键部分）+ 摘要机制
- **功能影响**: 某些工具可能需要完整结果
  - **缓解**: 可配置的最大长度，特殊工具可豁免
- **兼容性**: 需要确保所有工具都能正确处理截断结果
  - **缓解**: 渐进式实施，充分测试
