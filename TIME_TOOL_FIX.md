# 时间工具修复说明

## 问题

用户问"现在几点了？"时，系统存在以下问题：

1. **时间不准确**：LLM返回的是旧时间（2024-06-12），而不是当前时间
2. **计算器工具误用**：步骤4和5尝试用计算器处理时间字符串（"2024-06-12T10:30:45Z"），导致语法错误

## 解决方案

### 1. 添加时间工具 (TimeTool)

**位置**: `src/tools/time_tool.py`

**功能**:
- 获取当前时间
- 获取UTC时间
- 时区转换（简单实现）
- 格式化时间输出

**使用示例**:
```python
# 获取当前时间
tool.execute("current_time")
# 返回: {"success": True, "formatted": "现在是2026年01月28日 13:18"}

# 获取UTC时间
tool.execute("utc")
# 返回: {"success": True, "utc_time": "2026-01-28T05:18:00Z"}
```

### 2. 更新规划提示词

在规划提示词中明确列出 `get_time` 工具：
- 如果步骤需要获取当前时间、时区信息，使用 "get_time"

### 3. 改进计算器工具输入准备

**改进点**:
- 排除时间格式（如 "2024-06-12T10:30:45Z"）
- 只接受纯数学表达式
- 如果无法提取数学表达式，返回空字符串，触发降级

### 4. 注册时间工具

在 `AgentOrchestrator._register_default_tools()` 中注册时间工具。

## 预期效果

现在当用户问"现在几点了？"时：

1. **规划阶段**：LLM会为时间相关步骤分配 `tool_type: "get_time"`
2. **执行阶段**：调用时间工具获取真实当前时间
3. **结果**：返回准确的时间（如 "现在是2026年01月28日 13:18"）

## 测试

重新运行 console 客户端，测试时间查询：

```powershell
python run_console.py
```

然后输入："现在几点了？"

应该能看到：
- 步骤使用 `get_time` 工具
- 返回准确的当前时间
- 不再出现计算器语法错误
