# Agent 多工具组合调用能力分析

## 当前能力评估

### ✅ 已具备的能力

#### 1. 任务分解能力
- **PlanningAgent** 可以将复杂问题分解为多个步骤
- 每个步骤可以指定不同的工具类型
- 支持依赖关系定义（`dependencies` 字段）
- 支持并行组定义（`parallel_groups` 字段）

**代码位置**: `src/agent/multi_agent_system.py:PlanningAgent.decompose_task()`

#### 2. 顺序执行能力
- **ExecutionAgent** 可以按顺序执行每个步骤
- 每个步骤可以调用不同的工具
- 步骤结果会传递到 `context["step_results"]` 中

**代码位置**: `src/agent/multi_agent_system.py:ExecutionAgent.execute_step()`

#### 3. 依赖检查能力
- **CoordinationAgent** 会检查步骤的依赖关系
- 只有依赖满足的步骤才会被执行

**代码位置**: `src/agent/multi_agent_system.py:CoordinationAgent._check_dependencies()`

#### 4. 结果传递能力
- 步骤结果会存储在 `state["step_results"]` 中
- 后续步骤可以通过 `context["step_results"]` 访问前面的结果

**代码位置**: `src/agent/multi_agent_system.py:ExecutionAgent._prepare_tool_input()`

### ⚠️ 潜在问题和限制

#### 1. 步骤间数据传递不够明确
**问题**:
- 步骤结果存储在列表中，但后续步骤如何引用特定步骤的结果不够清晰
- `_prepare_tool_input()` 可能没有充分利用前面的步骤结果

**影响**: 中等 - 可能影响复杂多步骤任务的执行效果

**示例场景**:
```
步骤1: 搜索 "北京天气" -> 结果: {"temperature": 25, "city": "北京"}
步骤2: 计算 "如果温度是25度，需要穿多少衣服？" 
       -> 需要引用步骤1的结果，但当前实现可能无法正确传递
```

#### 2. 依赖关系检查可能不够完善
**问题**:
- `_check_dependencies()` 的实现可能比较简单
- 可能没有处理循环依赖
- 可能没有处理部分依赖（如步骤3依赖步骤1或步骤2）

**影响**: 中等 - 可能影响复杂依赖关系的处理

#### 3. 并行执行支持有限
**问题**:
- 虽然规划阶段支持 `parallel_groups`，但执行阶段可能没有真正并行执行
- 当前实现是顺序执行所有步骤

**影响**: 低 - 主要影响性能，不影响功能正确性

#### 4. 步骤失败后的处理
**问题**:
- 如果某个步骤失败，后续步骤可能仍然会执行（即使依赖未满足）
- 没有重试机制
- 没有动态调整计划的能力

**影响**: 中等 - 可能影响复杂任务的鲁棒性

#### 5. 工具输入准备可能不够智能
**问题**:
- `_prepare_tool_input()` 可能只是简单地将步骤描述作为输入
- 没有充分利用前面的步骤结果来构建输入

**影响**: 高 - 直接影响多工具组合调用的效果

## 实际测试场景

### 场景1: 简单多步骤任务
**问题**: "先搜索北京今天的天气，然后告诉我应该穿什么衣服"

**当前能力**: ✅ 应该可以处理
- 步骤1: 使用 `search_web` 搜索天气
- 步骤2: 使用 `none` (直接推理) 基于天气推荐衣服

### 场景2: 数据传递任务
**问题**: "搜索'Python异步编程'的最新文章，然后总结前3篇的核心观点"

**当前能力**: ⚠️ 可能有问题
- 步骤1: 使用 `search_web` 搜索文章
- 步骤2: 需要从步骤1的结果中提取前3篇文章，然后总结
- **问题**: 步骤2可能无法正确获取步骤1的搜索结果

### 场景3: 复杂依赖任务
**问题**: "计算2024年1月1日到今天的总天数，然后计算如果每天存100元，总共存了多少钱"

**当前能力**: ✅ 应该可以处理
- 步骤1: 使用 `get_time` 获取当前时间
- 步骤2: 使用 `calculate` 计算天数差
- 步骤3: 使用 `calculate` 计算总金额
- **依赖**: 步骤3依赖步骤2，步骤2依赖步骤1

### 场景4: 多工具组合任务
**问题**: "搜索'新能源汽车市场'的最新报告，提取关键数据，然后计算未来3年的市场增长率预测"

**当前能力**: ⚠️ 可能有问题
- 步骤1: 使用 `search_web` 搜索报告
- 步骤2: 使用 `pdf` 或 `document` 工具提取数据（如果报告是PDF）
- 步骤3: 使用 `calculate` 计算增长率
- **问题**: 步骤2和步骤3需要正确使用步骤1的结果

## 建议的优化方向

### 1. 增强步骤间数据传递
- 在 `_prepare_tool_input()` 中，明确引用前面步骤的结果
- 支持步骤结果的命名引用（如 `step_1_result`, `step_2_data`）
- 自动将前面的步骤结果注入到当前步骤的上下文中

### 2. 改进依赖关系处理
- 实现更完善的依赖检查（包括循环依赖检测）
- 支持部分依赖（OR依赖）
- 支持条件依赖（如果步骤1成功，执行步骤2；否则执行步骤3）

### 3. 实现真正的并行执行
- 对于 `parallel_groups` 中的步骤，真正并行执行
- 使用 `asyncio.gather()` 并发执行独立步骤

### 4. 增强错误处理和重试
- 步骤失败后，根据依赖关系决定是否继续执行后续步骤
- 实现步骤级别的重试机制
- 支持动态调整计划（如果某个步骤失败，尝试替代方案）

### 5. 智能工具输入准备
- 分析步骤描述，自动提取需要引用的步骤
- 将前面步骤的结果格式化为当前工具需要的输入格式
- 支持模板化输入（如 "基于{step_1_result}，执行{current_step_description}"）

## 结论

### 当前状态
- ✅ **基本能力**: Agent 具备多工具组合调用的基本能力
- ⚠️ **高级能力**: 在复杂场景下可能存在数据传递和依赖处理的问题
- ⚠️ **性能优化**: 并行执行支持有限

### 建议
1. **短期**: 优化 `_prepare_tool_input()` 以更好地利用前面步骤的结果
2. **中期**: 实现真正的并行执行和更完善的依赖处理
3. **长期**: 支持动态计划调整和智能错误恢复

### 测试建议
建议创建以下测试场景来验证多工具组合调用能力：
1. 简单多步骤任务（验证基本流程）
2. 数据传递任务（验证步骤间数据传递）
3. 复杂依赖任务（验证依赖关系处理）
4. 多工具组合任务（验证工具组合效果）
